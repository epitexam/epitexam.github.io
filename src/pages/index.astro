---
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import TechStack from "../components/TechStack.astro";
import GitHubProject from "../components/GitHubProject.astro";
import {
	SITE_DESCRIPTION,
	SITE_TITLE,
	GITHUB_URL,
	TECH_CATEGORIES,
} from "../consts";
import { Image } from "astro:assets";
import profile from "../assets/profile.webp";
import type { Project } from "../types/github";

const username = SITE_TITLE.toLowerCase().replace(/\s+/g, "");
let projects: Project[] = [];

if (import.meta.env.SSR) {
	try {
		const token = import.meta.env.TOKEN_GITHUB;
		const response = await fetch(
			`https://api.github.com/users/${username}/repos?sort=pushed&per_page=6`,
			{
				headers: token ? { Authorization: `token ${token}` } : {},
				signal: AbortSignal.timeout(5000),
			},
		);
		if (response.ok) {
			projects = (await response.json()) as Project[];
		}
	} catch (error) {
		projects = [];
	}
}
---

<!doctype html>
<html lang="fr">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
	</head>

	<body class="bg-[rgb(var(--bg))]">
		<Header />

		<main class="stable-layout animate-fadeIn">
			<section class="hero-v">
				<div class="avatar-container">
					<Image
						src={profile}
						alt=""
						width={90}
						height={90}
						class="avatar-img"
						loading="eager"
					/>
					<span class="profile-handle">@{SITE_TITLE}</span>
				</div>

				<h1 class="hero-title">Développeur Web Full-Stack</h1>

				<p class="hero-description">
					Développeur passionné par l'embarqué, le web et les systèmes
					connectés. Spécialisé en développement Full-stack.
				</p>

				<div class="cta-group">
					<a
						href={GITHUB_URL}
						target="_blank"
						class="btn-pill btn-solid">GitHub</a
					>
					<a href="/blog" class="btn-pill btn-outline"
						>Blog technique</a
					>
				</div>

				<div class="hash-list">
					<span>#WebDevelopment</span>
					<span>#LowLevel</span>
					<span>#EmbeddedSystems</span>
					<span>#Backend</span>
					<span>#DevOps</span>
				</div>
			</section>

			<section class="stack-v">
				<div class="section-divider">
					<div class="line"></div>
					<span class="label">Expertise technique</span>
					<div class="line"></div>
				</div>

				<div class="stack-rows">
					{
						TECH_CATEGORIES.map((cat) => (
							<div class="stack-row">
								<span class="row-label">{cat.label}</span>
								<div class="row-items">
									{cat.items.map((t) => (
										<TechStack tech={t} />
									))}
								</div>
							</div>
						))
					}
				</div>
			</section>

			<section class="projects-v">
				<div class="projects-header">
					<div class="icon-indicator"></div>
					<h2>Mes projets</h2>
				</div>

				<div class="projects-grid">
					{
						projects.length > 0 ? (
							projects.map((repo, i) => (
								<GitHubProject project={repo} eager={i < 2} />
							))
						) : (
							<div class="projects-fallback">
								<p>Impossible de charger les projets GitHub.</p>
								<a href={GITHUB_URL}>
									Voir sur GitHub directement →
								</a>
							</div>
						)
					}
				</div>
			</section>
		</main>

		<Footer />
	</body>
</html>

<style>
	.stable-layout {
		display: flex;
		flex-direction: column;
		align-items: center;
		width: 100%;
		max-width: 960px;
		margin: 0 auto;
		border-left: none !important;
		box-sizing: border-box;
	}

	section {
		width: 100%;
		display: flex;
		flex-direction: column;
		align-items: center;
		margin-bottom: 4rem;
	}

	.avatar-container {
		display: flex;
		flex-direction: column;
		align-items: center;
		margin-bottom: 2rem;
	}

	.avatar-img {
		border-radius: 50%;
		border: 2px solid rgba(var(--accent), 0.2);
		margin-bottom: 0.5rem;
	}

	.profile-handle {
		font-family: var(--font-title);
		font-size: 0.8rem;
		opacity: 0.4;
	}

	.hero-title {
		text-align: center;
		font-size: clamp(2rem, 6vw, 3.5rem);
		line-height: 1.1;
		margin-bottom: 1.5rem;
		max-width: 900px;
		font-weight: 800;
	}

	.hero-description {
		text-align: center;
		max-width: 700px;
		font-size: 1.1rem;
		opacity: 0.7;
		margin-bottom: 2.5rem;
	}

	.cta-group {
		display: flex;
		gap: 1rem;
		margin-bottom: 3rem;
	}

	.hash-list {
		display: flex;
		gap: 1.5rem;
		font-family: var(--font-title);
		font-size: 0.8rem;
		opacity: 0.2;
	}

	.section-divider {
		display: flex;
		align-items: center;
		width: 100%;
		gap: 1.5rem;
		margin-bottom: 3rem;
	}
	.line {
		flex: 1;
		height: 1px;
		background: rgba(var(--accent), 0.1);
	}
	.label {
		font-size: 0.7rem;
		text-transform: uppercase;
		opacity: 0.4;
		letter-spacing: 0.2em;
		white-space: nowrap;
	}

	.stack-rows {
		width: 100%;
		display: flex;
		flex-direction: column;
		gap: 2rem;
	}
	.stack-row {
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: 0.75rem;
	}
	.row-label {
		font-size: 0.65rem;
		opacity: 0.3;
		text-transform: uppercase;
	}
	.row-items {
		display: flex;
		flex-wrap: wrap;
		justify-content: center;
		gap: 0.25rem;
	}

	.projects-header {
		text-align: center;
		margin-bottom: 3rem;
	}
	.icon-indicator {
		width: 30px;
		height: 2px;
		background: rgb(var(--accent));
		margin: 0 auto 1rem;
	}

	.projects-grid {
		display: grid;
		grid-template-columns: repeat(2, 1fr);
		gap: 1.5rem;
		width: 100%;
	}

	.projects-fallback {
		grid-column: span 2;
		padding: 3rem;
		border: 1px dashed rgba(var(--accent), 0.1);
		border-radius: 8px;
		text-align: center;
		opacity: 0.5;
	}

	.btn-pill {
		padding: 0.8rem 2.5rem;
		border-radius: 50px;
		font-family: var(--font-title);
		font-weight: 700;
		font-size: 0.9rem;
		text-decoration: none !important;
		transition: transform 0.2s ease;
	}
	.btn-solid {
		background: rgb(var(--text));
		color: rgb(var(--bg));
	}
	.btn-outline {
		border: 1px solid rgba(var(--text), 0.2);
		color: rgb(var(--text));
	}
	.btn-pill:hover {
		transform: translateY(-2px);
	}

	@media (max-width: 768px) {
		.projects-grid {
			grid-template-columns: 1fr;
		}
		.hero-title {
			font-size: 2.2rem;
		}
		.cta-group {
			flex-direction: column;
			width: 100%;
		}
		.btn-pill {
			text-align: center;
		}
		.hash-list {
			display: none;
		}
	}
</style>
