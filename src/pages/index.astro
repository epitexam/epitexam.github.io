---
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import TechStack from "../components/TechStack.astro";
import GitHubProject from "../components/GitHubProject.astro";
import { SITE_DESCRIPTION, SITE_TITLE, GITHUB_URL } from "../consts";
import { Image } from "astro:assets";
import profile from "../assets/profile.webp";
import type { Project } from "../types/github";

const TECH_STACK = [
	"ElectronJS",
	"Tauri",
	"React",
	"Next.js",
	"Preact",
	"Astro",
	"TailwindCSS",
	"Typescript",
	"Javascript",
	"Redux",
	"Jest",
	"Cypress",
	"Lua",
	"Node.js",
	"Nest",
	"Fastify",
	"Elysia",
	"Express.js",
	"Bun",
	"Python",
	"C",
	"C++",
	"Godot",
	"Postgres",
	"MongoDB",
	"MariaDB",
	"Prisma",
	"Redis",
	"Docker",
	"Podman",
	"Linux",
	"Windows ðŸ’€",
	"Debian",
	"Ubuntu",
	"Fedora",
	"Arch linux",
	"Asm 6502 / x64",
	"Arduino",
	"Raspberry",
	"ESP32",
] as const;

let projects: Project[] = [];
if (import.meta.env.SSR) {
	try {
		const token = import.meta.env.TOKEN_GITHUB;
		const username = SITE_TITLE.toLowerCase().replace(/\s+/g, "");

		const response = await fetch(
			`https://api.github.com/users/${username}/repos?sort=pushed&per_page=4`,
			{
				headers: token ? { Authorization: `token ${token}` } : {},
				signal: AbortSignal.timeout(5000),
			},
		);

		if (response.ok) {
			const repos = (await response.json()) as Project[];
			projects = repos.slice(0, 4);
		}
	} catch (error) {
		console.warn("Failed to fetch GitHub projects:", error);
		projects = [];
	}
}

const lastUpdate = new Date().toLocaleDateString("fr-FR");
---

<html lang="fr">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
	</head>

	<body class="min-h-screen flex flex-col">
		<Header />

		<main
			class="flex-grow px-4 sm:px-6 md:px-8 py-8 sm:py-12 max-w-5xl mx-auto space-y-12 sm:space-y-16"
		>
			<section class="text-center space-y-4 sm:space-y-6" id="hero">
				<div class="flex flex-col items-center gap-3 sm:gap-4">
					<Image
						src={profile}
						alt={`Avatar de ${SITE_TITLE}`}
						width={64}
						height={64}
						loading="eager"
						fetchpriority="high"
						class="rounded-full border border-accent/30 hover:border-accent/50 transition-colors"
						format="webp"
					/>
					<h1
						class="text-2xl sm:text-3xl md:text-4xl font-bold tracking-tight"
					>
						Ici <span class="text-accent glow-text"
							>{SITE_TITLE} !</span
						> ðŸ‘‹
					</h1>
					<p
						class="text-base sm:text-lg text-text/80 max-w-2xl mx-auto leading-relaxed"
					>
						DÃ©veloppeur passionnÃ© par l'embarquÃ©, le web et les
						systÃ¨mes connectÃ©s.
					</p>
					<p
						class="text-xs sm:text-sm text-text/60"
						aria-label="SpÃ©cialitÃ©s"
					>
						Full-stack / IoT / Bas niveau â€¢ ðŸ‡«ðŸ‡·
					</p>
					<div
						class="flex items-center gap-2 text-xs"
						role="status"
						aria-label="Statut de disponibilitÃ©"
					>
						<div
							class="w-2 h-2 sm:w-2.5 sm:h-2.5 rounded-full bg-green-400"
							aria-hidden="true"
						>
						</div>
						<span class="text-green-400 font-medium"
							>Disponible pour de nouveaux projets</span
						>
					</div>
				</div>

				<div
					class="flex flex-wrap justify-center gap-3 sm:gap-4 mt-4 sm:mt-6"
				>
					<a
						href="/blog"
						class="btn btn-neutral min-h-[44px] px-6 flex items-center"
						aria-label="Voir les articles du blog"
					>
						Le blog
					</a>
					<a
						href={GITHUB_URL}
						target="_blank"
						rel="noopener noreferrer"
						class="btn btn-accent min-h-[44px] px-6 flex items-center"
						aria-label="Visiter le profil GitHub"
					>
						GitHub
					</a>
				</div>
			</section>

			<section
				class="text-center space-y-4 sm:space-y-6 py-4 sm:py-8"
				id="tech-stack"
				aria-labelledby="tech-stack-title"
			>
				<h2
					id="tech-stack-title"
					class="text-lg sm:text-xl font-bold text-accent tracking-tight"
				>
					Au quotidien :
				</h2>
				<div
					class="stack-marquee mt-8 sm:mt-12"
					role="marquee"
					aria-label="Liste des technologies utilisÃ©es"
				>
					<div class="marquee-track">
						{
							TECH_STACK.map((tech, index) => (
								<TechStack tech={tech} />
							))
						}
					</div>
				</div>
			</section>

			<section
				class="space-y-4 sm:space-y-6"
				id="projects"
				aria-labelledby="projects-title"
			>
				<h2
					id="projects-title"
					class="text-lg sm:text-xl font-bold text-accent tracking-tight"
				>
					Mes derniers projets :
				</h2>
				<div
					class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6 mt-8 sm:mt-12"
				>
					{
						projects.length > 0 ? (
							projects.map((repo: Project) => (
								<GitHubProject project={repo} />
							))
						) : (
							<div
								class="col-span-full text-center py-8"
								role="status"
							>
								<p class="text-sm text-text/60 mb-4">
									Aucun projet public trouvÃ© sur GitHub.
								</p>
								<a
									href={GITHUB_URL}
									target="_blank"
									rel="noopener noreferrer"
									class="btn btn-outline text-xs"
								>
									Voir GitHub
								</a>
							</div>
						)
					}
				</div>
			</section>

			<footer class="text-center pt-8 border-t border-text/10">
				<p
					class="text-xs text-text/50"
					aria-label="DerniÃ¨re mise Ã  jour"
				>
					DerniÃ¨re mise Ã  jour : <time
						datetime={new Date().toISOString()}>{lastUpdate}</time
					>
				</p>
			</footer>
		</main>

		<Footer />
	</body>
</html>

<style>
	.stack-marquee {
		position: relative;
		overflow: hidden;
		mask-image: linear-gradient(
			to right,
			transparent 0%,
			black 8%,
			black 92%,
			transparent 100%
		);
		-webkit-mask-image: linear-gradient(
			to right,
			transparent 0%,
			black 8%,
			black 92%,
			transparent 100%
		);
	}

	.marquee-track {
		display: flex;
		gap: 1rem;
		white-space: nowrap;
		width: max-content;
		animation: marquee-scroll 180s linear infinite;
		padding: 0.5rem 0;
		will-change: transform;
	}

	@keyframes marquee-scroll {
		0% {
			transform: translateX(0);
		}
		100% {
			transform: translateX(-50%);
		}
	}

	@media (max-width: 640px) {
		.marquee-track {
			gap: 0.75rem;
			animation-duration: 120s;
			padding: 0.375rem 0;
		}

		.stack-marquee {
			mask-image: linear-gradient(
				to right,
				transparent 0%,
				black 4%,
				black 96%,
				transparent 100%
			);
			-webkit-mask-image: linear-gradient(
				to right,
				transparent 0%,
				black 4%,
				black 96%,
				transparent 100%
			);
		}
	}

	@media (prefers-reduced-motion: reduce) {
		.marquee-track {
			animation: none;
			justify-content: center;
			width: 100%;
			flex-wrap: wrap;
			gap: 0.75rem;
		}

		.stack-marquee {
			mask-image: none;
			-webkit-mask-image: none;
			overflow: visible;
		}
	}

	@media (max-width: 360px) {
		.marquee-track {
			animation: none;
			flex-wrap: wrap;
			justify-content: center;
			width: 100%;
		}

		.stack-marquee {
			mask-image: none;
			-webkit-mask-image: none;
		}
	}

	@media (prefers-color-scheme: dark) {
		.stack-marquee {
			mask-image: linear-gradient(
				to right,
				transparent 0%,
				rgb(10, 12, 20) 8%,
				rgb(10, 12, 20) 92%,
				transparent 100%
			);
		}
	}
</style>
