---
import BaseHead from "../components/BaseHead.astro";
import Footer from "../components/Footer.astro";
import Header from "../components/Header.astro";
import { SITE_TITLE } from "../consts";

const success = Astro.url.searchParams.get("success") === "true";
---

<!doctype html>
<html lang="fr">
    <head>
        <BaseHead
            title={`${SITE_TITLE} - Contact`}
            description="Contactez-moi pour discuter de vos projets, collaborations ou questions. Envoyez votre message directement via ce formulaire sécurisé."
        />
    </head>

    <body
        class="flex flex-col min-h-screen bg-[rgb(var(--bg))] text-[rgb(var(--text))] font-mono selection:bg-[rgba(var(--accent),0.3)]"
    >
        <Header />

        <main
            class="grow flex flex-col items-center justify-center animate-fadeIn"
        >
            <div class="max-w-xl w-full">
                <header class="text-center mb-10">
                    <p class="text-[rgba(var(--text),0.7)] leading-relaxed">
                        Si vous avez un projet, une question ou souhaitez juste
                        dire bonjour, envoyez-moi un message. Je vous répondrai
                        dès que possible.
                    </p>
                </header>

                {
                    success && (
                        <div class="mb-8 p-4 border border-green-500/50 bg-green-500/10 rounded-lg text-green-400 font-medium text-center animate-bounce">
                            Merci ! Votre message a bien été envoyé.
                        </div>
                    )
                }

                <div
                    id="errorMessage"
                    role="alert"
                    class="hidden mb-8 p-4 border border-red-500/50 bg-red-500/10 rounded-lg text-red-400 font-medium text-center"
                >
                </div>

                <div class="form-container">
                    <form
                        id="contactForm"
                        action="https://formspree.io/f/xovgkrbn"
                        method="POST"
                        class="flex flex-col gap-6"
                        autocomplete="on"
                    >
                        <input
                            type="hidden"
                            name="_next"
                            value={`${Astro.url.origin}${Astro.url.pathname}?success=true`}
                        />
                        <input
                            type="hidden"
                            name="_subject"
                            value={`Nouveau message de contact - ${SITE_TITLE}`}
                        />

                        <div style="display:none!important;" aria-hidden="true">
                            <input
                                type="text"
                                name="website"
                                tabindex="-1"
                                autocomplete="off"
                            />
                        </div>

                        <div class="input-group">
                            <label for="email" class="label-text"
                                >Votre email</label
                            >
                            <input
                                type="email"
                                id="email"
                                name="email"
                                required
                                placeholder="nom@domaine.com"
                                class="input-field"
                                autocomplete="email"
                            />
                            <span class="sub-label"
                                >Votre email ne sera jamais partagé</span
                            >
                        </div>

                        <div class="input-group">
                            <label for="message" class="label-text"
                                >Votre message</label
                            >
                            <textarea
                                id="message"
                                name="message"
                                required
                                rows="5"
                                placeholder="Écrivez votre message ici..."
                                class="input-field resize-none"
                                minlength="20"
                                maxlength="2000"
                                spellcheck="true"></textarea>
                            <div class="flex justify-between items-center mt-1">
                                <span
                                    class="sub-label text-[rgb(var(--accent))] opacity-70"
                                    >Markdown supporté</span
                                >
                                <span id="charCount" class="sub-label"
                                    ><span id="charCountValue">0</span>/2000
                                    caractères</span
                                >
                            </div>
                        </div>

                        <div
                            class="flex items-start gap-3 p-3 bg-[rgba(var(--accent),0.03)] rounded border border-[rgba(var(--accent),0.1)]"
                        >
                            <input
                                type="checkbox"
                                id="privacy"
                                name="privacy"
                                required
                                class="mt-1 accent-[rgb(var(--accent))]"
                            />
                            <label
                                for="privacy"
                                class="text-xs text-[rgba(var(--text),0.7)] cursor-pointer"
                            >
                                J'accepte que mes données soient utilisées
                                uniquement pour répondre à mon message
                            </label>
                        </div>

                        <button
                            id="submitBtn"
                            type="submit"
                            class="submit-button"
                        >
                            <span id="submitText">Envoyer le message</span>
                            <span id="submitSpinner" class="hidden ml-2"
                                >...</span
                            >
                        </button>

                        <p
                            class="text-[10px] text-center text-[rgba(var(--text),0.4)] uppercase tracking-widest"
                        >
                            Powered by Formspree
                        </p>
                    </form>
                </div>
            </div>
        </main>

        <Footer />

        <style>
            .form-container {
                background: linear-gradient(
                    145deg,
                    rgba(var(--bg), 0.8) 0%,
                    rgba(var(--accent), 0.03) 100%
                );
                border: 1px solid rgba(var(--accent), 0.15);
                border-radius: var(--radius-md);
                padding: 2rem;
                box-shadow: 0 20px 50px -20px rgba(0, 0, 0, 0.5);
            }

            .input-group {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }

            .label-text {
                font-family: var(--font-title);
                font-size: 0.85rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                color: rgb(var(--accent));
            }

            .input-field {
                background: rgba(var(--bg), 0.5);
                border: 1px solid rgba(var(--accent), 0.2);
                border-radius: var(--radius-sm);
                padding: 0.75rem;
                color: rgb(var(--text));
                transition: all 0.2s ease;
                font-family: var(--font-body);
            }

            .input-field:focus {
                outline: none;
                border-color: rgb(var(--accent));
                background: rgba(var(--accent), 0.05);
                box-shadow: 0 0 0 3px rgba(var(--accent), 0.1);
            }

            .sub-label {
                font-size: 0.7rem;
                color: rgba(var(--text), 0.5);
            }

            .submit-button {
                background: rgb(var(--accent));
                color: rgb(var(--bg));
                padding: 0.9rem;
                border-radius: var(--radius-sm);
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.1em;
                cursor: pointer;
                border: none;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .submit-button:hover:not(:disabled) {
                filter: brightness(1.1);
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(var(--accent), 0.3);
            }

            .submit-button:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                transform: none !important;
                box-shadow: none !important;
            }

            @media (max-width: 640px) {
                .form-container {
                    padding: 1rem;
                }
            }
        </style>

        <script is:inline>
            function updateCharCount() {
                const textarea = document.getElementById("message");
                const charCountValue =
                    document.getElementById("charCountValue");

                if (!textarea || !charCountValue) return;

                const length = textarea.value.length;
                charCountValue.textContent = length;

                if (length > 0 && length < 20) {
                    charCountValue.classList.add("text-red-500");
                } else {
                    charCountValue.classList.remove("text-red-500");
                }
            }

            function showError(message) {
                const errorDiv = document.getElementById("errorMessage");
                if (!errorDiv) return;
                errorDiv.textContent = message;
                errorDiv.classList.remove("hidden");
                setTimeout(() => errorDiv.classList.add("hidden"), 5000);
            }

            document.addEventListener("DOMContentLoaded", () => {
                const form = document.getElementById("contactForm");
                const messageTextarea = document.getElementById("message");

                if (!form || !messageTextarea) return;

                messageTextarea.addEventListener("input", updateCharCount);
                updateCharCount();

                form.addEventListener("submit", function (e) {
                    const honeypot = this.querySelector(
                        'input[name="website"]',
                    );

                    if (honeypot && honeypot.value.trim() !== "") {
                        e.preventDefault();
                        return;
                    }

                    if (messageTextarea.value.trim().length < 20) {
                        e.preventDefault();
                        showError(
                            "Le message doit contenir au moins 20 caractères.",
                        );
                        messageTextarea.focus();
                        return;
                    }

                    const submitBtn = document.getElementById("submitBtn");
                    const submitText = document.getElementById("submitText");
                    const submitSpinner =
                        document.getElementById("submitSpinner");

                    if (submitBtn && submitText && submitSpinner) {
                        submitBtn.disabled = true;
                        submitText.textContent = "Envoi en cours...";
                        submitSpinner.classList.remove("hidden");
                    }
                });
            });
        </script>
    </body>
</html>
